#!/bin/bash
echo "`date`: Checking for Node processes" |& tee -a $1
ps -ef  | grep '/node ' | grep -v 'grep'

NODE_PIDS=`ps -ef | grep '/node ' | grep -v 'grep' | awk '{print $2;}'`

# Try killing them
if [ -n "$NODE_PIDS" ]; then
        echo "Killing: $NODE_PIDS" |& tee -a $1
        kill $NODE_PIDS |& tee -a $1
        cmd_status=${PIPESTATUS[0]} 
        echo "`date`: Waiting 10s for Node to exit. kill CMD status: $cmd_status\n" |& tee -a $1
        sleep 10
fi

# Check to see if all Nodes exited
NODE_PIDS=`ps -ef  | grep '/node ' | grep -v 'grep' | awk '{print $2;}'`

# If not, try kill -9
while [ -n "$NODE_PIDS" ]; do
        echo "Trying kill -9: $NODE_PIDS"  |& tee -a $1
        kill -9 $NODE_PIDS |& tee -a $1
        cmd_status=${PIPESTATUS[0]} 
        echo "`date`: Waiting 10s for Node to die. kill -9 CMD status: $cmd_status\n"  |& tee -a $1
        sleep 10
        NODE_PIDS=`ps -ef | grep '/node ' | grep -v 'grep' | awk '{print $2;}'`
done

if [[ -n $(tail -n 3 $1 | grep "Operation not permitted") ]]; then 
   echo -e "kill operation on PID:$NODE_PIDS is not permitted\n"
else
   exit 1;
fi 

